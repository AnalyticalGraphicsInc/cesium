<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta
      name="description"
      content="Visualize worldwide, high-resolution terrain."
    />
    <meta name="cesium-sandcastle-labels" content="Tutorials, Showcases" />
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script
      type="text/javascript"
      src="../../../Build/CesiumUnminified/Cesium.js"
      nomodule
    ></script>
    <script type="module" src="../load-cesium-es6.js"></script>
  </head>
  <body
    class="sandcastle-loading"
    data-sandcastle-bucket="bucket-requirejs.html"
  >
    <style>
      @import url(../templates/bucket.css);
    </style>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay"><h1>Loading...</h1></div>
    <div id="toolbar">
      <div id="terrainMenu"></div>
      <div id="zoomButtons"></div>
      <div id="showQuadtreeLevel"></div>
      <div id="sampleButtons"></div>
    </div>
    <script id="cesium_sandcastle_script">
      function startup(Cesium) {
        "use strict";

        //Sandcastle_Begin
        var worldTerrain = Cesium.createWorldTerrain({
          requestWaterMask: true,
          requestVertexNormals: true,
        });

        var arcGisTerrainProvider = new Cesium.ArcGISTiledElevationTerrainProvider(
          {
            url:
              "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",
          }
        );

        var locationOptions = [
          {
            name: "Mount Everest",
            target: new Cesium.Cartesian3(
              300770.50872389384,
              5634912.131394585,
              2978152.2865545116
            ),
            offset: new Cesium.Cartesian3(
              6344.974098678562,
              -793.3419798081741,
              2499.9508860763162
            ),
          },
          {
            name: "Half Dome",
            target: new Cesium.Cartesian3(
              -2489625.0836225147,
              -4393941.44443024,
              3882535.9454173897
            ),
            offset: new Cesium.Cartesian3(
              -6857.40902037546,
              412.3284835694358,
              2147.5545426812023
            ),
          },
          {
            name: "San Francisco Bay",
            target: new Cesium.Cartesian3(
              -2708814.85583248,
              -4254159.450845907,
              3891403.9457429945
            ),
            offset: new Cesium.Cartesian3(
              70642.66030209465,
              -31661.517948317807,
              35505.179997143336
            ),
          },
        ];

        var viewer = new Cesium.Viewer("cesiumContainer", {
          terrainProvider: arcGisTerrainProvider,
        });
        viewer.scene.globe.enableLighting = false;
        viewer.scene.fog.enabled = false;

        window.viewer = viewer;

        var quadTreeDataSource = new Cesium.CustomDataSource("quadtree");
        viewer.dataSources.add(quadTreeDataSource);

        var testedPointsDataSource = new Cesium.CustomDataSource(
          "testedPoints"
        );
        viewer.dataSources.add(testedPointsDataSource);

        function localToWorld(transform, local) {
          return Cesium.Matrix4.multiplyByPoint(
            transform,
            local,
            new Cesium.Cartesian3()
          );
        }

        function drawQuadTreeNode(transform, node, color) {
          var topLeft = node.topLeft;
          var bottomRight = node.bottomRight;
          var minHeight = node.minHeight;
          var maxHeight = node.maxHeight;

          var topLeftWorldSpace = localToWorld(
            transform,
            new Cesium.Cartesian3(topLeft.x, topLeft.y, 0)
          );
          var bottomRightWorldSpace = localToWorld(
            transform,
            new Cesium.Cartesian3(bottomRight.x, bottomRight.y, 0)
          );

          var minHeightWorldSpace = localToWorld(
            transform,
            new Cesium.Cartesian3(0, 0, minHeight)
          );
          var maxHeightWorldSpace = localToWorld(
            transform,
            new Cesium.Cartesian3(0, 0, maxHeight)
          );

          var topLeftCartographic = Cesium.Cartographic.fromCartesian(
            topLeftWorldSpace
          );
          var bottomRightCartographic = Cesium.Cartographic.fromCartesian(
            bottomRightWorldSpace
          );
          var minHeightCartographic = Cesium.Cartographic.fromCartesian(
            minHeightWorldSpace
          );
          var maxHeightCartographic = Cesium.Cartographic.fromCartesian(
            maxHeightWorldSpace
          );

          var rect = new Cesium.Rectangle(
            topLeftCartographic.longitude,
            topLeftCartographic.latitude,
            bottomRightCartographic.longitude,
            bottomRightCartographic.latitude
          );

          quadTreeDataSource.entities.add({
            rectangle: {
              coordinates: rect,
              material: color,
              rotation: Cesium.Math.toRadians(0),
              extrudedHeight: maxHeightCartographic.height,
              height: minHeightCartographic.height,
              outline: true, // height must be set for outline to display
              outlineColor: Cesium.Color.BLACK,
            },
          });
        }

        function addDot(transform, local, color, radius) {
          radius = radius || 50;
          var point = localToWorld(transform, local);
          viewer.entities.add({
            position: point,
            ellipsoid: {
              radii: new Cesium.Cartesian3(50.0, 50.0, 50.0),
              material: color,
            },
          });
        }

        function drawPointList(color, dataSource, points) {
          if (points && points.length) {
            for (var i = 0; i < points.length; i++) {
              var p = points[i];
              dataSource.entities.add({
                position: p,
                ellipsoid: {
                  radii: new Cesium.Cartesian3(10.0, 10.0, 10.0),
                  material: color,
                },
              });
            }
          }
        }

        Sandcastle.addDefaultToolbarMenu(
          locationOptions.map(function (option) {
            return {
              text: option.name,
              onselect: function () {
                viewer.camera.lookAt(option.target, option.offset);
                viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
              },
            };
          }),
          "zoomButtons"
        );

        function flatten(node) {
          if (!node) {
            return [];
          }
          return [node]
            .concat(flatten(node.topLeftTree))
            .concat(flatten(node.bottomLeftTree))
            .concat(flatten(node.topRightTree))
            .concat(flatten(node.bottomRightTree));
        }

        function showQuadTreeAtLevel(level) {
          if (window.lastPickDetails) {
            var root = window.lastPickDetails.mesh._trianglePicking._quadtree;
            var transform = window.lastPickDetails.traceDetails.transform;

            var nodes = flatten(root);
            var nodesAtLevel = nodes.filter(function (n) {
              return n.level === level;
            });

            quadTreeDataSource.entities.removeAll();
            for (var i = 0; i < nodesAtLevel.length; i++) {
              var n = nodesAtLevel[i];
              var color = Cesium.Color.GREEN.withAlpha(0.1);
              if (n.isHit) {
                color = Cesium.Color.GOLD.withAlpha(0.1);
              }
              if (n.isSpecial) {
                color = Cesium.Color.RED.withAlpha(0.1);
              }
              drawQuadTreeNode(transform, n, color);
            }
          }
        }

        function getShowAtLevelFn(level) {
          return function () {
            showQuadTreeAtLevel(level);
          };
        }

        var showQuadTreeOptions = [];
        var optionLevel = 0;
        while (optionLevel < 10) {
          showQuadTreeOptions.push({
            text: "Quadtree Level " + optionLevel,
            onselect: getShowAtLevelFn(optionLevel),
          });
          optionLevel++;
        }

        Sandcastle.addToolbarMenu(showQuadTreeOptions, "showQuadtreeLevel");

        var scene = viewer.scene;
        var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);

        handler.setInputAction(function (movement) {
          window.showPickDetails = true;
          var scene = viewer.scene;
          var camera = scene.camera;

          var ray = camera.getPickRay(movement.position);
          var pickPosition = scene.globe.pick(ray, scene);

          window.showPickDetails = false;

          var details = window.lastPickDetails;
          console.trace("details here");

          if (details) {
            viewer.entities.removeAll();

            debugger;
            var transform = details.traceDetails.transform;

            // drawQuadTreeNode(transform, root, Cesium.Color.GOLD.withAlpha(0.1));
            // drawQuadTreeNode(
            //   transform,
            //   root.topLeftTree,
            //   Color.GREEN.withAlpha(0.1)
            // );
            // drawQuadTreeNode(
            //   transform,
            //   root.bottomLeftTree,
            //   Color.ORANGE.withAlpha(0.1)
            // );
            // drawQuadTreeNode(
            //   transform,
            //   root.topRightTree,
            //   Color.BLUE.withAlpha(0.1)
            // );
            // drawQuadTreeNode(
            //   transform,
            //   root.bottomRightTree,
            //   Color.OLIVE.withAlpha(0.1)
            // );

            // var positions = [
            //   [-0.5, 0.5, 0.5],
            //   [0.5, -0.5, 0.5],
            //   [0.5, 0.5, -0.5],
            //   [-0.5, -0.5, 0.5],
            //   [-0.5, 0.5, -0.5],
            //   [0.5, -0.5, -0.5],
            //   [-0.5, -0.5, -0.5],
            //   [0.5, 0.5, 0.5],
            // ];
            //
            // for (var iii = 0; iii < positions.length; iii++) {
            //   var pasdf = positions[iii];
            //   addDot(
            //     new Cesium.Cartesian3(pasdf[0], pasdf[1], pasdf[2]),
            //     Cesium.Color.fromRandom()
            //   );
            // }
            //
            //

            var C = Cesium.Color;
            var Cartesian3 = Cesium.Cartesian3;

            addDot(transform, new Cartesian3(-0.5, -0.5, -0.5), C.BLUE, 100);
            addDot(transform, new Cartesian3(-0.4, -0.4, -0.4), C.GREEN, 100);
            addDot(transform, new Cartesian3(0.4, 0.4, 0.4), C.GREEN, 100);
            addDot(transform, new Cartesian3(0.5, 0.5, 0.5), C.YELLOW, 100);

            // addDot(
            //   new Cesium.Cartesian3(0.5, 0.5, -0.5),
            //   Cesium.Color.DARKORANGE
            // );
            // addDot(new Cesium.Cartesian3(-0.5, -0.5, 0.5), Cesium.Color.BROWN);
            // addDot(new Cesium.Cartesian3(-0.5, 0.5, -0.5), Cesium.Color.YELLOW);
            // addDot(
            //   new Cesium.Cartesian3(-0.5, -0.5, 0.5),
            //   Cesium.Color.GAINSBORO
            // );
            // addDot(new Cesium.Cartesian3(-0.5, 0.5, -0.5), Cesium.Color.GOLD);
            // addDot(new Cesium.Cartesian3(0.5, -0.5, -0.5), Cesium.Color.CYAN);

            // viewer.entities.add({
            //   rectangle: {
            //     coordinates: details.traceDetails.rectangle,
            //     material: Cesium.Color.GREEN.withAlpha(0.1),
            //     rotation: Cesium.Math.toRadians(0),
            //     extrudedHeight: 8000.0,
            //     height: 0,
            //     outline: true, // height must be set for outline to display
            //     outlineColor: Cesium.Color.BLACK,
            //   },
            // });
            // var r = details.mesh.boundingSphere3D.radius;
            // var c = details.mesh.boundingSphere3D.center;
            // viewer.entities.add({
            //   name: "Red sphere with black outline",
            //   position: c,
            //   ellipsoid: {
            //     radii: new Cesium.Cartesian3(r, r, r),
            //     material: Cesium.Color.RED.withAlpha(0.1),
            //     outline: true,
            //     outlineColor: Cesium.Color.BLACK,
            //   },
            // });
            viewer.entities.add({
              name: "ray",
              position: Cesium.Cartesian3.ZERO,
              polyline: {
                positions: [ray.origin, Cesium.Ray.getPoint(ray, 10000)],
                color: Cesium.Color.GREEN,
              },
            });

            var colorByLevel = {
              0: Cesium.Color.RED,
              1: Cesium.Color.ORANGE,
              2: Cesium.Color.YELLOW,
              3: Cesium.Color.GREEN,
              4: Cesium.Color.AQUA,
              5: Cesium.Color.BLUE,
              6: Cesium.Color.PURPLE,
              7: Cesium.Color.BEIGE,
              8: Cesium.Color.BEIGE,
              9: Cesium.Color.BEIGE,
              10: Cesium.Color.BEIGE,
            };

            if (details.traceDetails && details.traceDetails.trianglesTested) {
              var triangles = details.traceDetails.trianglesTested;
              for (var i = 0; i < triangles.length; i++) {
                var triangle = triangles[i];
                viewer.entities.add({
                  polygon: {
                    hierarchy: triangle.positions,
                    perPositionHeight: true,
                    material: colorByLevel[triangle.level].withAlpha(0.5),
                    outline: true,
                    outlineColor: Cesium.Color.CYAN,
                    outlineWidth: 10,
                  },
                });
              }
            }

            // if (details.traceDetails && details.traceDetails.coolTriangles) {
            //   var trianglesasdf = details.traceDetails.coolTriangles;
            //   for (var asdf = 0; asdf < trianglesasdf.length; asdf++) {
            //     var triangleasdf = trianglesasdf[asdf];
            //     viewer.entities.add({
            //       polygon: {
            //         hierarchy: triangleasdf,
            //         perPositionHeight: true,
            //         material: Cesium.Color.PINK,
            //         outline: true,
            //         outlineColor: Cesium.Color.CYAN,
            //         outlineWidth: 10,
            //       },
            //     });
            //   }
            // }

            testedPointsDataSource.entities.removeAll();

            drawPointList(
              Cesium.Color.RED,
              testedPointsDataSource,
              details.traceDetails &&
                details.traceDetails.firstPointsInHeightmap
            );

            drawPointList(
              Cesium.Color.BLUE,
              testedPointsDataSource,
              details.traceDetails && details.traceDetails.coolPoints
            );

            if (details.traceDetails.intersectedTriangle) {
              viewer.entities.add({
                polygon: {
                  hierarchy: details.traceDetails.intersectedTriangle,
                  perPositionHeight: true,
                  material: Cesium.Color.GOLD,
                  outline: true,
                  outlineColor: Cesium.Color.GOLD,
                  outlineWidth: 10,
                },
              });
            }
          }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        //Sandcastle_End
        Sandcastle.finishedLoading();
      }
      if (typeof Cesium !== "undefined") {
        window.startupCalled = true;
        startup(Cesium);
      }
    </script>
  </body>
</html>
